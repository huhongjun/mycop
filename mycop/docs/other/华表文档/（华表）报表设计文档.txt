设计思想

    大体上来说，一个报表包括两部分：数据部分和格式部分，数据部分也就是报表需要展示的信息，如科目、金额等，格式部分也就是报表需要的样式，如单元格合并、是否居中显示等。基于这种划分，设想用一个通用查询来定义报表需要的数据，一个报表可以定义多个查询，暂且把这些查询出的数据命名为报表元数据。报表元数据不一定就是报表需要展示的数据，可能需要对它们进行一些加工，才能得到报表需要展示的信息，因此，设想用一些公式来解决这个问题。公式需要做两件事，一是对元数据进行加工，得到报表需要展示的数据，二是对报表展示的数据的格式进行处理。

    为简化工作，以华表为基础来处理相关问题。

    制作一个报表时，先要通过通用查询来设定该报表需要的数据，但这步仅是生成查询语句，并不查询出数据；然后要设定一个报表模版，报表模版中放置一些公式，公式中需要查询语句的字段作为参数；查看报表时，先根据该报表设定的查询语句查出需要的数据并传送到客户端，然后解析模版中的公式取得数据并按一定的格式显示出来。




有关规定或说明

    1.查询语句的字段命名为数据指标，对所有数据指标会进行编号，以F[N,M]形式给出。参看模版设置。
   
    2.系统的每个SESSION值命名为变量指标，对所有变量指标进行编号，以P[N]形式给出。参看模版设置。查询语句中可以对变量指标引用。

    3.对数据的处理可以在SQL层或公式层，目前由于只定义少量公式，故有很大部分是需在SQL层完成的(把数据要组装成满足公式需要的结构)。

    4.公式中对指数据指标的引用一般以F开头，对单元格的引用以C开头，带A的是作用于横向的，带B的是作用于竖向的。

    5.模版的开始3行为报表头，最后3行为报表尾，这6行不能有公式，可以引用指标(P[N]或F[N,M])，不会对这6行数据的显示样式进行任何改变，也就是模版中设定是怎么样，查看报表时也就是怎么样。对数据指标(F[N,M])如果有多个值，只取第一个。数据指标有一种扩展形式为F[N,M,K,比较值]，K为指标编号，K指标对应的值与比较值作比较来确定M指标对应的值，如果有多个值，只取第一个，比较值可以是对一个单元格的引用，则形式为C开头，后面紧跟行号和列号，中间以-分隔，如C1-1,表示第一个单元格。

　　6.字符^作为不被转换字符。因为公式中没有区分数据类型，当一个数据可以转换为数值型数据时，公式会把它当作数值处理，但有时不需要这种自动的转换，就可以在SQL语句中加上^作前缀，使得它不能被转换。如指标单中的文号，其形式为00000014，如果没有加前缀^，则显示为14.



公式定义

    公式以!()为标志，()内为公式内容。

    递归类（数据记录间有父子关系）

    !(recurA(F[m,n,k,初始值,i,d]))：用于横向显示，如果父亲节点多于一个儿子则带合计列。m为指标组编号，n为把内容显示在表格的指标编号，k为父指标编号，初始值为父指标的开始值，可以是对一个单元格的引用，则形式为C开头，后面紧跟行号和列号，中间以-分隔，如C1-1,表示第一个单元格，i为隐藏不显示的指标编号，d为要带合计列的层数，如果该参数没有，则表示所有层都带合计列，否则只该层带合计列，层数编号从0开始。

    !(recurB(F[m,n,k,初始值,i,d]))：用于竖向带缩进格式显示，如果初始值多于一个儿子则带合计行。m为指标组编号，n为把内容显示在表格的指标编号，k为父指标编号，初始值为父指标的开始值，可以是对一个单元格的引用，则形式为C开头，后面紧跟行号和列号，中间以-分隔，如C1-1,表示第一个单元格，i为隐藏不显示的指标编号，d为是否要带合计行的标志，该参数存在则表示不要，否则要，该参数优先于对儿子个数的判定。

    取数据类

    !(getdataA(F[m,n,i]))： 从数据指标取数据。m为指标组编号，n为把内容显示在表格的指标编号，i为隐藏不显示的指标编号。

    !(getdataB(F[m,n,dc,cc,i]))： m是指标组编号，n要显示的数据的指标编号，dc是与表格的某列的值相比较的指标编号，cc是要比较的表格的列号，i为隐藏不显示的指标编号。cc列的数据是用recurB公式求出的，本公式根据cc列叶子节点数据取数据。

    !(getdataC(F[m,n,dr,dc,cr,cc]))： 用于根据表格的行和列的数据来取数据。m是指标组编号，n要显示的数据的指标编号，dr是与表格的某行的值相比较的指标编号，dc是与表格的某列的值相比较的指标编号，如果dr或dc没有给定值，则表示没有行或列的比较。cr是要比较的表格的行号或是一个具体单元格值，cc是要比较的表格的列号或是一个具体单元格值，如果cr或cc没有给定值，则它们为行号和列号，且值为公式所在的行号或列号减一，cr和cc具体值的形式为大写C开头，后面紧跟行号和列号，中间以-分隔，如C1-1,表示第一个单元格。

    其它类

    !(percentB(C[r1,c1,r2,c2]))：计算百分比。r1：用来作除数的单元格的行号的范围值，形式为n-m，n为开始的行号，可以是具体的一个数值，也可以是*，代表最大行，m为结尾的行号，可以是一个具体的数值，也可以是*，代表最大行，也可以是(*-k)，表示除最后k行外的所有行；c1：用来作除数的单元格的列号，只能是具体的某一列；r2：用来作被除数的单元格的行号的范围值，表示形式与r1相同，如果其范围仅表示某一行，则r2,c2所确定的单元格的值用来作所有除数的被除数，否则仅做行相同的除数的被除数；c2：用来作被除数的单元格的列号，只能是具体的某一列。

    !(copytmp(F[m,n,i]))： 表页(模版)复制公式，本公式规定只能置于表页的第一个单元格内。m为指标组编号，决定复制的份数，n为把内容显示在表页页签的指标编号，i为把内容隐藏于表页第一个单元格内不显示的指标编号，当前表页(模版)需要根据该值取数据。
    


向TQRYTEMPLET表插数据
INSERT INTO TQRYTEMPLET(CREATOR,CATE,NAME,SPEC,CONTENT,NEEDPARAM,FZID,FID) SELECT CREATOR,CATE,NAME,SPEC,CONTENT,NEEDPARAM,299 AS FZID,FID*1000 AS FID FROM TQRYTEMPLET WHERE FZID=894